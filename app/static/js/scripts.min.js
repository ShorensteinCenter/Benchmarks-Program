const apiForm=document.querySelector(".api-key-form"),csrf_token=document.querySelector("meta[name=csrf-token]").content,submitApiKey=async e=>{if(e.preventDefault(),toggleForm(!0,apiForm,submitApiKey),apiKeyClientSideValidation()){const e=new Headers({"X-CSRFToken":csrf_token}),t=new FormData(apiForm),n=new Request("/validateAPIKey",{method:"POST",credentials:"same-origin",headers:e,body:t});try{const e=await fetch(n);if(!e.ok)throw new Error(e.statusText);showMsg("valid",apiForm),getLists()}catch(e){toggleForm(!1,apiForm,submitApiKey),showMsg("invalid",apiForm),console.error("Failed to fetch:",e)}}else toggleForm(!1,apiForm,submitApiKey),showMsg("invalid",apiForm)},toggleForm=(e,t,n)=>{const s=t.querySelectorAll(".form-submit-wrapper, #submit"),o=t.querySelectorAll(".form-input-wrapper, #key");if(e){t.removeEventListener("submit",n);for(let e=0;e<o.length;++e)o[e].classList.remove("invalid");for(let e=0;e<s.length;++e)s[e].classList.add("inactive")}else{for(let e=0;e<s.length;++e)s[e].classList.remove("inactive");t.addEventListener("submit",n)}},apiKeyClientSideValidation=()=>{const e=apiForm.querySelector("#key").value;return 0!==e.length&&-1!==e.search("-us")},showMsg=(e,t)=>{msgFields=t.querySelectorAll(".form-input-wrapper, #key");for(let t=0;t<msgFields.length;++t)msgFields[t].classList.add(e)},getLists=async()=>{const e=new Headers({"X-CSRFToken":csrf_token}),t=new Request("/getLists",{method:"GET",credentials:"same-origin",headers:e});try{const e=await fetch(t);if(!e.ok)throw new Error(e.statusText);{const t=await e.json();setupListsTable(t.lists)}}catch(e){console.log("Failed to fetch:",e)}},slideLeft=e=>{const t=document.querySelectorAll(".container-fluid");for(let n=0;n<t.length;++n)t[n].style.transform="translateX("+e+")"};apiForm.addEventListener("submit",submitApiKey);let listeners=[],listId="",memberCount=0,unsubscribeCount=0,cleanedCount=0,openRate=0;const setupListsTable=e=>{let t="<tbody>";for(let n=0;n<e.length;++n)t+="<tr>",t+="<td>"+e[n].name+"</td>",t+="<td class='d-none d-sm-table-cell'>"+e[n].stats.member_count.toLocaleString()+"</td>",t+="<td class='d-none d-sm-table-cell'></td>",t+="<td class='analyze-link-column'><a class='analyze-link' list-id='"+e[n].id+"' member-count='"+e[n].stats.member_count+"' unsubscribe-count='"+e[n].stats.unsubscribe_count+"' cleaned-count='"+e[n].stats.cleaned_count+"' open-rate='"+e[n].stats.open_rate+"' href='#'><div class='analyze-link-text'>Analyze</div><svg class='i-chevron-right' viewBox='0 0 32 32' width='16' height='16' fill='none' stroke='currentcolor' stroke-linecap='round' stroke-linejoin='round' stroke-width='3'><path d='M12 30 L24 16 12 2'></path></svg></a></td>",t+="</tr>";t+="</tbody>",document.querySelector("thead").insertAdjacentHTML("afterend",t);const n=document.querySelectorAll(".analyze-link");for(let e=0;e<n.length;++e){const t=n[e].getAttribute("list-id"),s=n[e].getAttribute("member-count"),o=n[e].getAttribute("unsubscribe-count"),i=n[e].getAttribute("cleaned-count");openRate=n[e].getAttribute("open-rate"),listener=analyzeList(t,s,o,i,openRate),n[e].addEventListener("click",listener),listeners[e]=listener}slideLeft("-100vw")},analyzeList=(e,t,n,s,o)=>i=>{i.preventDefault();const r=document.querySelectorAll(".analyze-link");for(let e=0;e<r.length;++e)r[e].removeEventListener("click",listeners[e]);listId=e,memberCount=t,unsubscribeCount=n,cleanedCount=s,openRate=o,slideLeft("-200vw")},emailForm=document.querySelector(".email-form"),emailClientSideValidation=()=>{const e=emailForm.querySelector("#key").value;return 0!==e.length&&-1!==e.search("@")&&-1!==e.search(".")},submitEmail=async e=>{if(e.preventDefault(),toggleForm(!0,emailForm,submitEmail),emailClientSideValidation()){let e=new FormData(emailForm);e.append("listId",listId),e.append("memberCount",memberCount),e.append("unsubscribeCount",unsubscribeCount),e.append("cleanedCount",cleanedCount),e.append("openRate",openRate);const t=new Headers({"X-CSRFToken":csrf_token}),n=new Request("/submitEmail",{method:"POST",credentials:"same-origin",headers:t,body:e});try{const e=await fetch(n);if(!e.ok)throw new Error(e.statusText);slideLeft("-300vw")}catch(e){toggleForm(!1,emailForm,submitEmail),showMsg("invalid",emailForm),console.error("Failed to fetch:",e)}}else toggleForm(!1,emailForm,submitEmail),showMsg("invalid",emailForm)};emailForm.addEventListener("submit",submitEmail);