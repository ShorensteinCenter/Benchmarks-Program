const tagField=(e,t)=>{t?(e.classList.remove("invalid"),e.parentElement.classList.remove("invalid"),e.classList.add("valid"),e.parentElement.classList.add("valid")):(e.classList.remove("valid"),e.parentElement.classList.remove("valid"),e.classList.add("invalid"),e.parentElement.classList.add("invalid"))},clientSideValidateField=e=>{const t=e.getAttribute("custom_type"),r=e.value;let o=!0;return o="key"==t?0!==r.length&&-1!==r.indexOf("-us"):"email"==t?0!==r.length&&-1!==r.indexOf("@")&&-1!==r.indexOf("."):0!==r.length,tagField(e,o),o},clientSideValidateForm=e=>{const t=e.querySelectorAll("input:not(.disabled-elt), select:not(.disabled-elt)");let r=!0;for(let e=0;e<t.length;++e){clientSideValidateField(t[e])||(r=!1)}return r},inputs=document.querySelectorAll(".form-input-wrapper:not(.enter-stats) input, .form-input-wrapper select");for(let e=0;e<inputs.length;++e){const t=inputs[e];"INPUT"==t.tagName?t.addEventListener("blur",e=>clientSideValidateField(e.currentTarget)):t.addEventListener("change",e=>clientSideValidateField(e.currentTarget))}const disable=e=>{if(NodeList.prototype.isPrototypeOf(e))for(let t=0;t<e.length;++t)e[t].classList.add("disabled-elt");else e.classList.add("disabled-elt")},enable=e=>{if(NodeList.prototype.isPrototypeOf(e))for(let t=0;t<e.length;++t)e[t].classList.remove("disabled-elt");else e.classList.remove("disabled-elt")},debounced=(e,t)=>{let r;return(...o)=>{r&&clearTimeout(r),r=setTimeout(()=>{t(...o),r=null},e)}},csrfToken=document.querySelector("meta[name=csrf-token]").content,basicInfoForm=document.querySelector("#basic-info-form"),submitBasicInfo=async e=>{if(e.preventDefault(),basicInfoForm.removeEventListener("submit",submitBasicInfo),!clientSideValidateForm(basicInfoForm))return void basicInfoForm.addEventListener("submit",submitBasicInfo);const t=basicInfoForm.querySelectorAll("input");disable(t);const r=new Headers({"X-CSRFToken":csrfToken}),o=new FormData(basicInfoForm),a=new Request("/validate-basic-info",{method:"POST",credentials:"same-origin",headers:r,body:o});try{const r=await fetch(a);if(r.ok){const e=await r.json();if("existing"==e.org){const t="/confirmation?title="+"Thanks!"+"&body="+("approved"==e.user?"You're all set! We've emailed you a unique access link.":"We've received your details. Once our team has reviewed your submission, we'll email you with instructions for accessing our benchmarking tool.");window.location.href=t}else window.location.href="/org-info"}else{if(422!=r.status)throw new Error(r.statusText);{const e=basicInfoForm.querySelectorAll(".invalid");for(let t=0;t<e.length;++t)e[t].classList.remove("invalid");const o=await r.json();for(const[e,t]of Object.entries(o))tagField(basicInfoForm.querySelector("#"+e));enable(t),basicInfoForm.addEventListener("submit",submitBasicInfo)}}}catch(e){console.error(e)}};basicInfoForm&&basicInfoForm.addEventListener("submit",submitBasicInfo);const orgForm=document.querySelector("#org-form"),submitOrg=async e=>{if(e.preventDefault(),orgForm.removeEventListener("submit",submitOrg),!clientSideValidateForm(orgForm))return void orgForm.addEventListener("submit",submitOrg);const t=orgForm.querySelectorAll("label, .custom-control-label");disable(t);const r=new Headers({"X-CSRFToken":csrfToken}),o=new FormData(orgForm),a=new Request("/validate-org-info",{method:"POST",credentials:"same-origin",headers:r,body:o});try{const r=await fetch(a);if(r.ok){const e="/confirmation?title="+"Thanks!"+"&body="+("approved"==(await r.json()).user?"You're all set! We've emailed you a unique access link.":"We've received your details. Once our team has reviewed your submission, we'll email you with instructions for accessing our benchmarking tool.");window.location.href=e}else{if(422!=r.status)throw new Error(r.statusText);{const e=orgForm.querySelectorAll(".invalid");for(let t=0;t<e.length;++t)e[t].classList.remove("invalid");const o=await r.json();for(const[e,t]of Object.entries(o))tagField(orgForm.querySelector("#"+e.replace("_","-")+"-wrapper"));enable(t),orgForm.addEventListener("submit",submitOrg)}}}catch(e){console.error(e)}},toggleOtherAffField=(e,t)=>{const r=["valid","invalid"];e.classList.remove(...r),e.classList.toggle("disabled-elt"),t.classList.remove(...r),e.value=""};if(orgForm){orgForm.addEventListener("submit",submitOrg);const e=orgForm.querySelector("#other_affiliation"),t=orgForm.querySelector("#other_affiliation_name"),r=orgForm.querySelector("#other-affiliation-name-wrapper");e.addEventListener("change",()=>toggleOtherAffField(t,r))}const toggles=document.querySelectorAll("span.switch"),changeActivationStatus=async e=>{const t=e.currentTarget;t.removeEventListener("change",changeActivationStatus),disable(t);const r=t.getAttribute("switch-id"),o=new Headers({"X-CSRFToken":csrfToken}),a=new Request("/activate-user?user="+r,{method:"GET",credentials:"same-origin",headers:o});try{const r=await fetch(a);if(!r.ok)throw new Error(r.statusText);enable(t),t.addEventListener("change",changeActivationStatus)}catch(e){console.error(e)}};if(toggles)for(let e=0;e<toggles.length;++e){toggles[e].addEventListener("change",changeActivationStatus)}const apiKeyForm=document.querySelector("#api-key-form"),submitApiKey=async e=>{if(e.preventDefault(),apiKeyForm.removeEventListener("submit",submitApiKey),!clientSideValidateForm(apiKeyForm))return void apiKeyForm.addEventListener("submit",submitApiKey);const t=apiKeyForm.querySelectorAll('select,input:not([type="checkbox"]), .custom-control-label');disable(t);const r=new Headers({"X-CSRFToken":csrfToken}),o=new FormData(apiKeyForm),a=new Request("/validate-api-key",{method:"POST",credentials:"same-origin",headers:r,body:o});try{const r=await fetch(a);if(r.ok)window.location.href="/select-list";else{if(422!=r.status)throw new Error(r.statusText);{const e=apiKeyForm.querySelectorAll(".invalid");for(let t=0;t<e.length;++t)e[t].classList.remove("invalid");const o=await r.json();for(const[e,t]of Object.entries(o))tagField(apiKeyForm.querySelector("#"+e));enable(t),apiKeyForm.addEventListener("submit",submitApiKey)}}}catch(e){console.error(e)}};apiKeyForm&&apiKeyForm.addEventListener("submit",submitApiKey);const listsTable=document.querySelector(".lists-table");let listeners=[];const analysisTime=.24,secondsToHm=e=>{if(0==e)return"N/A";e=Number(e);const t=Math.floor(e/3600),r=Math.floor(e%3600/60),o=(t>0?t+(0==r?1==t?" hour":" hours":1==t?" hour, ":" hours, "):"")+(r>0?r+(1==r?" minute":" minutes"):"");return o?"~"+o:"<1 minute"},setupListsTable=e=>{let t="<tbody>";for(let r=0;r<e.length;++r){t+="<tr>",t+="<td>"+e[r].name+"</td>",t+="<td class='d-none d-md-table-cell'>"+e[r].stats.member_count.toLocaleString()+"</td>",t+="<td class='d-none d-md-table-cell'>"+secondsToHm(.24*e[r].stats.member_count)+"</td>",e[r].stats.member_count>0?t+="<td class='analyze-link-column'><a class='analyze-link' list-id='"+e[r].id+"' list-name='"+e[r].name+"' total-count='"+(e[r].stats.member_count+e[r].stats.unsubscribe_count+e[r].stats.cleaned_count)+"' open-rate='"+e[r].stats.open_rate+"' date-created='"+e[r].date_created+"' campaign-count='"+e[r].stats.campaign_count+"' href='#'><div class='analyze-link-text'>Analyze</div><svg class='i-chevron-right' viewBox='0 0 32 32' width='16' height='16' fill='none' stroke='currentcolor' stroke-linecap='round' stroke-linejoin='round' stroke-width='3'><path d='M12 30 L24 16 12 2'></path></svg></a></td>":t+="<td></td>",t+="</tr>"}t+="</tbody>",document.querySelector("thead").insertAdjacentHTML("afterend",t);const r=document.querySelectorAll(".analyze-link");for(let e=0;e<r.length;++e){const t=r[e].getAttribute("list-id"),o=r[e].getAttribute("list-name"),a=r[e].getAttribute("total-count"),n=r[e].getAttribute("open-rate"),i=r[e].getAttribute("date-created"),s=r[e].getAttribute("campaign-count"),l=analyzeList(t,o,a,n,i,s);r[e].addEventListener("click",l),listeners[e]=l}},analyzeList=(e,t,r,o,a,n)=>async i=>{i.preventDefault();const s=document.querySelectorAll(".analyze-link");for(let e=0;e<s.length;++e)s[e].removeEventListener("click",listeners[e]);disable(document.querySelectorAll(".lists-table"));const l=new Headers({"X-CSRFToken":csrfToken,"content-type":"application/json"}),c={list_id:e,list_name:t,total_count:r,open_rate:o,date_created:a,campaign_count:n},d={method:"POST",credentials:"same-origin",headers:l,body:JSON.stringify(c)},u=new Request("/analyze-list",d);try{if(!(await fetch(u)).ok){enable(document.querySelectorAll(".lists-table"));for(let e=0;e<s.length;++e)s[e].addEventListener("click",listeners[e]);throw new Error(i.statusText)}{const e="Sit Tight!",t="We're currently analyzing your MailChimp list. Once we've finished, we'll email you your report!";window.location.href="/confirmation?title="+e+"&body="+t}}catch(i){console.error(i)}},getListData=async()=>{const e=new Request("/get-list-data",{credentials:"same-origin"});try{const t=await fetch(e);if(!t.ok)throw new Error(t.statusText);{const e=await t.json();setupListsTable(e)}}catch(e){console.error(e)}};listsTable&&getListData();const indexBubbleChart=document.getElementById("index-bubble-chart"),dateDiff=e=>Math.floor((new Date-e)/2592e6),updateChart=e=>{const t=parseInt(document.getElementById("enter-list-size").value.replace(/,/g,"")),r=+document.getElementById("enter-open-rate").value.replace("%",""),o=document.getElementById("enter-list-age").value;if(isNaN(t)||t<0||isNaN(r)||r<0||r>100)return;const a=dateDiff(new Date(new Date(o).toUTCString())),n=r.toFixed(1);return Plotly.animate(indexBubbleChart,{data:[{x:[a],y:[n],text:["Age: "+a+" months<br>Open Rate: "+n+"%<br>Subscribers: "+t.toLocaleString()],marker:{size:[t]}}],traces:[1]},{transition:{duration:e,easing:"ease"},frame:{duration:e}})};if(indexBubbleChart){const e=JSON.parse(indexBubbleChart.getAttribute("data-subscribers")),t=JSON.parse(indexBubbleChart.getAttribute("data-open-rates")).map(e=>Math.round(1e3*e)/10),r=JSON.parse(indexBubbleChart.getAttribute("data-ages")),o=new Date(new Date((new Date).getFullYear()-5,0,1).toUTCString()),a=[{x:r,y:t,text:Array.from({length:r.length},(o,a)=>"Age: "+r[a]+" months<br>Open Rate: "+t[a]+"%<br>Subscribers: "+e[a].toLocaleString()),hoverinfo:"text",hoverlabel:{bgcolor:"rgba(167, 25, 48, .85)",font:{family:"Montserrat, sans-serif",size:12}},mode:"markers",marker:{size:e,sizeref:2*Math.max(...e)/3600,sizemode:"area",color:new Array(e.length).fill("rgba(167, 25, 48, .85)")}},{x:[dateDiff(o)],y:[7.5],text:["Age: "+dateDiff(o)+" months<br>Open Rate: 7.5%<br>Subscribers: 5,000"],hoverinfo:"text",hoverlabel:{bgcolor:"rgba(215, 164, 45, 0.85)",font:{color:"white",family:"Montserrat, sans-serif",size:12},bordercolor:"white"},mode:"markers",marker:{size:[5e3],sizeref:2*Math.max(...e)/3600,sizemode:"area",color:["rgba(215, 164, 45, 0.85)"]}}],n={font:{family:"Montserrat, sans-serif",size:16},yaxis:{range:[0,1.25*Math.max(...t)>100?100:1.25*Math.max(...t)],color:"#aaa",tickfont:{color:"#555"},tickprefix:"        ",ticksuffix:"%  ",title:"List Open Rate",titlefont:{color:"#555"},automargin:!0,fixedrange:!0},xaxis:{range:[0,1.15*Math.max(...r)],color:"#aaa",tickfont:{color:"#555"},tickformat:",",title:"List Age (Months)",titlefont:{color:"#555"},fixedrange:!0},showlegend:!1,height:525,margin:{t:5,b:105},hovermode:"closest"},i={responsive:!0,displayModeBar:!1};Plotly.newPlot(indexBubbleChart,a,n,i),flatpickr("#enter-list-age",{defaultDate:o,maxDate:"today",dateFormat:"m/d/Y"});const s=document.querySelectorAll(".enter-stats input");for(let e=0;e<s.length;++e){s[e].addEventListener("change",()=>updateChart(450))}const l=debounced(50,()=>{const e=indexBubbleChart.getBoundingClientRect(),t=e.top,r=e.bottom-45;if(t>=0&&r<=window.innerHeight){const e=document.getElementById("enter-list-size"),t=document.getElementById("enter-open-rate");e.value="25,000",t.value="30%",updateChart(1500),document.removeEventListener("scroll",l)}});document.addEventListener("scroll",l)}