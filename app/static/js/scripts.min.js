const tagField=(e,t)=>{t?(e.classList.remove("invalid"),e.parentElement.classList.remove("invalid"),e.classList.add("valid"),e.parentElement.classList.add("valid")):(e.classList.remove("valid"),e.parentElement.classList.remove("valid"),e.classList.add("invalid"),e.parentElement.classList.add("invalid"))},clientSideValidateField=e=>{const t=e.getAttribute("custom_type"),o=e.value;let n=!0;return n="key"==t?0!==o.length&&-1!==o.indexOf("-us"):"email"==t?0!==o.length&&-1!==o.indexOf("@")&&-1!==o.indexOf("."):0!==o.length,tagField(e,n),n},clientSideValidateForm=e=>{const t=e.querySelectorAll("input, select");let o=!0;for(let e=0;e<t.length;++e){clientSideValidateField(t[e])||(o=!1)}return o},inputs=document.querySelectorAll(".form-input-wrapper input, .form-input-wrapper select");for(let e=0;e<inputs.length;++e){const t=inputs[e];"INPUT"==t.tagName?t.addEventListener("keyup",e=>clientSideValidateField(e.currentTarget)):t.addEventListener("change",e=>clientSideValidateField(e.currentTarget))}const disable=e=>{if(NodeList.prototype.isPrototypeOf(e))for(let t=0;t<e.length;++t)e[t].classList.add("disabled-elt");else e.classList.add("disabled-elt")},enable=e=>{if(NodeList.prototype.isPrototypeOf(e))for(let t=0;t<e.length;++t)e[t].classList.remove("disabled-elt");else e.classList.remove("disabled-elt")},csrfToken=document.querySelector("meta[name=csrf-token]").content,basicInfoForm=document.querySelector("#basic-info-form"),submitBasicInfo=async e=>{if(e.preventDefault(),basicInfoForm.removeEventListener("submit",submitBasicInfo),disable(basicInfoForm.querySelectorAll("input")),!clientSideValidateForm(basicInfoForm))return enable(basicInfoForm.querySelectorAll("input")),void basicInfoForm.addEventListener("submit",submitBasicInfo);const t=new Headers({"X-CSRFToken":csrfToken}),o=new FormData(basicInfoForm),n=new Request("/validate-basic-info",{method:"POST",credentials:"same-origin",headers:t,body:o});try{const t=await fetch(n);if(t.ok){if("existing"==(await t.json()).org){const e="/confirmation?title="+"Thanks!"+"&body="+"We've received your details. Once our team has reviewed your submission, we'll email you with instructions for accessing our benchmarking tool.";window.location.href=e}else window.location.href="/org-info"}else{if(400!=t.status)throw new Error(t.statusText);{const e=basicInfoForm.querySelectorAll(".invalid");for(let t=0;t<e.length;++t)e[t].classList.remove("invalid");const o=await t.json();for(const[e,t]of Object.entries(o))tagField(basicInfoForm.querySelector("#"+e));enable(basicInfoForm.querySelectorAll("input")),basicInfoForm.addEventListener("submit",submitBasicInfo)}}}catch(e){console.error(e)}};basicInfoForm&&basicInfoForm.addEventListener("submit",submitBasicInfo);const orgForm=document.querySelector("#org-form"),submitOrg=async e=>{e.preventDefault(),orgForm.removeEventListener("submit",submitOrg);const t=orgForm.querySelectorAll("label, .custom-control-label");disable(t);const o=new Headers({"X-CSRFToken":csrfToken}),n=new FormData(orgForm),s=new Request("/validate-org-info",{method:"POST",credentials:"same-origin",headers:o,body:n});try{const o=await fetch(s);if(o.ok){const e="Thanks!",t="We've received your details. Once our team has reviewed your submission, we'll email you with instructions for accessing our benchmarking tool.";window.location.href="/confirmation?title="+e+"&body="+t}else{if(400!=o.status)throw new Error(o.statusText);{const e=orgForm.querySelectorAll(".invalid");for(let t=0;t<e.length;++t)e[t].classList.remove("invalid");const n=await o.json();for(const[e,t]of Object.entries(n))tagField(orgForm.querySelector("#"+e.replace("_","-")+"-wrapper"));enable(t),orgForm.addEventListener("submit",submitOrg)}}}catch(e){console.error(e)}};orgForm&&orgForm.addEventListener("submit",submitOrg);const toggles=document.querySelectorAll("span.switch"),changeActivationStatus=async e=>{const t=e.currentTarget;t.removeEventListener("change",changeActivationStatus),disable(t);const o=t.getAttribute("switch-id"),n=new Headers({"X-CSRFToken":csrfToken}),s=new Request("/activate-user?user="+o,{method:"GET",credentials:"same-origin",headers:n});try{const o=await fetch(s);if(!o.ok)throw new Error(o.statusText);enable(t),t.addEventListener("change",changeActivationStatus)}catch(e){console.error(e)}};if(toggles)for(let e=0;e<toggles.length;++e){toggles[e].addEventListener("change",changeActivationStatus)}const apiKeyForm=document.querySelector("#api-key-form"),submitApiKey=async e=>{e.preventDefault(),apiKeyForm.removeEventListener("submit",submitApiKey);const t=apiKeyForm.querySelectorAll('select,input:not([type="checkbox"]), .custom-control-label');if(disable(t),!clientSideValidateForm(apiKeyForm))return enable(t),void apiKeyForm.addEventListener("submit",submitApiKey);const o=new Headers({"X-CSRFToken":csrfToken}),n=new FormData(apiKeyForm),s=new Request("/validate-api-key",{method:"POST",credentials:"same-origin",headers:o,body:n});try{const o=await fetch(s);if(o.ok)window.location.href="/select-list";else{if(400!=o.status)throw new Error(o.statusText);{const e=apiKeyForm.querySelectorAll(".invalid");for(let t=0;t<e.length;++t)e[t].classList.remove("invalid");const n=await o.json();for(const[e,t]of Object.entries(n))tagField(apiKeyForm.querySelector("#"+e));enable(t),apiKeyForm.addEventListener("submit",submitApiKey)}}}catch(e){console.error(e)}};apiKeyForm&&apiKeyForm.addEventListener("submit",submitApiKey);const listsTable=document.querySelector(".lists-table");let listeners=[];const analysisTime=.24,secondsToHm=e=>{if(0==e)return"N/A";e=Number(e);const t=Math.floor(e/3600),o=Math.floor(e%3600/60),n=(t>0?t+(0==o?1==t?" hour":" hours":1==t?" hour, ":" hours, "):"")+(o>0?o+(1==o?" minute":" minutes"):"");return n?"~"+n:"<1 minute"},setupListsTable=e=>{let t="<tbody>";for(let o=0;o<e.length;++o){t+="<tr>",t+="<td>"+e[o].name+"</td>",t+="<td class='d-none d-md-table-cell'>"+e[o].stats.member_count.toLocaleString()+"</td>",t+="<td class='d-none d-md-table-cell'>"+secondsToHm(.24*e[o].stats.member_count)+"</td>",e[o].stats.member_count>0?t+="<td class='analyze-link-column'><a class='analyze-link' list-id='"+e[o].id+"' list-name='"+e[o].name+"' total-count='"+(e[o].stats.member_count+e[o].stats.unsubscribe_count+e[o].stats.cleaned_count)+"' open-rate='"+e[o].stats.open_rate+"' date-created='"+e[o].date_created+"' campaign-count='"+e[o].stats.campaign_count+"' href='#'><div class='analyze-link-text'>Analyze</div><svg class='i-chevron-right' viewBox='0 0 32 32' width='16' height='16' fill='none' stroke='currentcolor' stroke-linecap='round' stroke-linejoin='round' stroke-width='3'><path d='M12 30 L24 16 12 2'></path></svg></a></td>":t+="<td></td>",t+="</tr>"}t+="</tbody>",document.querySelector("thead").insertAdjacentHTML("afterend",t);const o=document.querySelectorAll(".analyze-link");for(let e=0;e<o.length;++e){const t=o[e].getAttribute("list-id"),n=o[e].getAttribute("list-name"),s=o[e].getAttribute("total-count"),i=o[e].getAttribute("open-rate"),r=o[e].getAttribute("date-created"),a=o[e].getAttribute("campaign-count"),l=analyzeList(t,n,s,i,r,a);o[e].addEventListener("click",l),listeners[e]=l}},analyzeList=(e,t,o,n,s,i)=>async r=>{r.preventDefault();const a=document.querySelectorAll(".analyze-link");for(let e=0;e<a.length;++e)a[e].removeEventListener("click",listeners[e]);disable(document.querySelectorAll(".lists-table"));const l=new Headers({"X-CSRFToken":csrfToken,"content-type":"application/json"}),c={list_id:e,list_name:t,total_count:o,open_rate:n,date_created:s,campaign_count:i},d={method:"POST",credentials:"same-origin",headers:l,body:JSON.stringify(c)},u=new Request("/analyze-list",d);try{if(!(await fetch(u)).ok){enable(document.querySelectorAll(".lists-table"));for(let e=0;e<a.length;++e)a[e].addEventListener("click",listeners[e]);throw new Error(r.statusText)}{const e="Sit Tight!",t="We're currently analyzing your MailChimp list. Once we've finished, we'll email you your report!";window.location.href="/confirmation?title="+e+"&body="+t}}catch(r){console.error(r)}},getListData=async()=>{const e=new Request("/get-list-data",{credentials:"same-origin"});try{const t=await fetch(e);if(!t.ok)throw new Error(t.statusText);{const e=await t.json();setupListsTable(e)}}catch(e){console.error(e)}};listsTable&&getListData();